# Веб-интерфейс к модулю 1С АлвеТрансКарго ATKDrive
## 1. Назначение продукта
Данный продукт осуществляет взаимодействие потребителя услуг компании с информационной системой управления грузоперевозками. Продукт предназначен для использования клиентами интернета, поэтому он размещается на внешнем, не входящем в корпоративную сеть, сервере.
Продукт осуществляет первичную автоматическую регистрацию потребителя, его дальнейшую авторизацию и верификацию его действий. Для авторизованного потребителя продукт выполняет трансляцию данных, передаваемых веб-клиентом из различных html-страниц GET/POST http-запросами в формат сообщения для программного модуля 1С, расположенного в корпоративной сети. Полученное в ответ сообщение транслируется в обратном направлении для вывода в соответствующие поля html-шаблона страницы.

Продукт разрабатывается исключительно как веб-приложение для веб-сервера. Необходимые изменения в модуле АлвеТрансКарго 1С в контексте разработки продукта не рассматриваются. Подразумевается, что модуль уже имеет функционал для взаимодействия с данным веб-приложением.
## 2. Первичная регистрация потребителя
Любая попытка регистрации потребителя для работы с системой формирует запись в соответствующей таблице базы данных продукта, расположенной на внешнем веб-сервере. Запись о потребителе имеет реквизит статуса потребителя, принимающий значения (как минимум): “новый”, “на утверждении”, “подтвержден” и “отклонен”.

Потребитель, регистрирующийся для работы с продуктом проходит два этапа проверки. Первый этап выполняется продуктом автоматически. После заполнения регистрационной формы, потребитель подтверждает достоверность данных через какой-либо канал обратной связи. 
Это может быть отправка на телефон потребителя СМС с кодом (требует подключения сторонних сервисов), либо отправка ссылки верификации на указанный потребителем электронный адрес.

Потребители, прошедшие первичную регистрацию должны быть удостоверены менеджером - физическим представителем предприятия и записаны в базу данных модуля 1С. Данные о вновь зарегистрировавшихся потребителях передаются в соответствующий экран модуля 1С по http (websocket) или иному сетевому запросу. При этом записи выставляется статус “на утверждении”.

Согласование записей таблиц потребителей продукта и базы данных модуля 1С выполняется по общему ключу, не требующему статуса “подтвержден”.
Дальнейшие запросы продукта к модулю 1С различных данных выполняются только для потребителей со статусом “подтвержден” либо “на утверждении”. В последнем случае ответ модуля 1С повлечет на изменение статуса потребителя на “подтвержден” либо “отклонен”.
## 3. Отправка запросов из модуля 1С к веб-интерфейсу
Коммуникация выполняется по протоколу websocket на URL, с авторизацией по логину и паролю средствами веб-сервера. Также в настройках веб-сервера возможно задать ограниченный диапазон обслуживаемых адресов. Последний способ сделает невозможной работу менеджера с удаленного рабочего места с динамическим адресом.
## 4. Отправка запросов из веб-интерфейса к модулю 1С
Коммуникация выполняется по протоколу TCP на задаваемый в настройках порт. Для  обеспечения безопасности сервер корпоративной сети должен позволять соединение только с определенного адреса, по которому расположен веб-интерфейс.
## 5. Формат сообщений
Сообщения межсерверных коммуникаций представляют из себя строку в кодировке UTF-8 в формате JSON. Кодированный в  JSON объект имеет обязательный и необязательные ключи:
```
{“code”:”действие, строка”, “data”:”{дополнительные данные, объект}”, “fail”:”сообщение об ошибке, строка”}
```
Обязательный ключ **code** содержит глагол повелительного наклонения, обозначающий суть запроса. В ответном сообщении в ключ **code** помещается значение из аналогичного ключа запроса. 

Необязательный ключ **data** содержит объект с набором данных, необходимых для обработки запроса или, для ответного сообщения, результат выполнения запроса.

Необязательный ключ **fail** используется в ответном сообщении для уточнения причины неудачной попытки выполнения запроса. Наличие этого ключа в сообщении -- само по себе является признаком неудачной обработки.
## HTML-формы
Основным фактором, определяющим структуру данных является содержимое html-шаблонов страниц. Значения переменных, подлежащих транслированию в модуль 1С и обратно вносятся в html-элементы, объединенные одним html DOM классом. Имена переменных определяет свойство id html-элемента. 
Таблицы трансляции списка http-параметров, получаемых ATKDrive  в запрос к модулю 1С строятся на основе синтаксического анализа html-шаблона либо указанием в шаблоне служебной информации в виде списка используемых имен переменных.


